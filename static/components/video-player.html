{{ define "components/video-player" }}

<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  // Setup YouTube iframe player
  var reportProgress = '{{ .ReportProgress }}' === "true"
  if (reportProgress) {
    document.getElementById("close-button")?.addEventListener("click", saveProgress)
    setInterval(saveProgress, 10000)
  }

  var player;
  var frame = document.getElementById("player")
  function onYouTubeIframeAPIReady() {
    player = new YT.Player(frame, {
      height: '100%',
      width: '100%',
      videoId: '{{ .Video.ID }}',
      playerVars: {
        'start': parseInt('{{ .Video.Progress }}') ?? 0,
        'rel': 0,
        'autoplay': 1,
        'playsinline': 1,
        'enablejsapi': 1,
        'iv_load_policy': 3
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }
  function onPlayerReady(event) {
    event.target.playVideo();
    document.getElementById("player-loading").classList.add("hidden")
  }
  function onPlayerStateChange(event) {
    if (reportProgress && (event.data == YT.PlayerState.ENDED || event.data == YT.PlayerState.PAUSED)) {
      saveProgress()
    }
  }
  var lastProgress = 0
  function saveProgress() {
    var currentTime = Math.floor(player.getCurrentTime())
    if (lastProgress === currentTime) return true
    lastProgress = currentTime

    fetch("/api/videos/{{ .Video.ID }}/progress?progress=" + currentTime, {
      method: 'POST',
      credentials: 'include'
    })
    return true
  }

  // Setup SponsorBlock
  var segmentsStr = '{{ .SkipSegmentsJSON }}'
  var segments = []
  try {
    segments = JSON.parse(segmentsStr)
  } catch (error) {
    console.info("no sponsorblock segments found")
  }

  if (segments.length > 0) {
    setInterval(() => {
      if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
        var currentTime = player.getCurrentTime()
        var segment = segments.find(segment => segment.start <= currentTime && segment.end >= currentTime)
        if (segment) {
          console.info("skipping segment")
          player.seekTo(segment.end, true)
        }
      }
    }, 1000)
  }
</script>

{{ end }}