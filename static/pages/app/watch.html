{{ define "app/watch" }}

<head>
  <title>Feedlr - {{ .Title }}</title>

  <meta property="og:title" content="{{ .Title }}">
  <meta property="og:type" content="video.episode" />
  <meta property="og:description" content="{{ .Description }}">
  <meta property="og:image" content="{{ .Thumbnail }}">
</head>

<div class="relative flex items-center justify-start w-full h-full">
  <div class="absolute flex items-center justify-center w-full h-full bg-black" id="player-loading">
    <span class="w-12 h-12 loading loading-spinner"></span>
  </div>
  <div id="player"></div>
  <a class="absolute opacity-50 hover:opacity-100 top-2 right-2 btn btn-primary btn-square" href="/app"
    id="close-button">
    {{template "icons/cross"}}
  </a>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  // Setup YouTube iframe player
  document.getElementById("close-button")?.addEventListener("click", saveProgress)
  setInterval(saveProgress, 10000)

  var player;
  var frame = document.getElementById("player")
  function onYouTubeIframeAPIReady() {
    player = new YT.Player(frame, {
      height: '100%',
      width: '100%',
      videoId: '{{ .ID }}',
      playerVars: {
        'start': parseInt('{{ .Progress }}') ?? 0,
        'rel': 0,
        'autoplay': 1,
        'playsinline': 1,
        'enablejsapi': 1,
        'iv_load_policy': 3
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }
  function onPlayerReady(event) {
    event.target.playVideo();
    document.getElementById("player-loading").classList.add("hidden")
  }
  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.ENDED || event.data == YT.PlayerState.PAUSED) {
      saveProgress()
    }
  }

  var lastProgress = 0
  function saveProgress() {
    var currentTime = Math.floor(player.getCurrentTime())
    if (lastProgress === currentTime) return true
    lastProgress = currentTime

    fetch("/api/videos/{{ .ID }}/progress?progress=" + currentTime, {
      method: 'POST',
      credentials: 'include'
    })
    return true
  }

  // Setup SponsorBlock
  var segmentsStr = '{{ .SegmentsJSON }}'
  var segments = []
  try {
    segments = JSON.parse(segmentsStr)
  } catch (error) {
    console.info("no sponsorblock segments found")
  }

  if (segments.length > 0) {
    setInterval(() => {
      if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) {
        var currentTime = player.getCurrentTime()
        var segment = segments.find(segment => segment.start <= currentTime && segment.end >= currentTime)
        if (segment) {
          console.info("skipping segment")
          player.seekTo(segment.end, true)
        }
      }
    }, 1000)
  }
</script>

{{ end }}